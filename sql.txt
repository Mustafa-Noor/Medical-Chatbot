# this file is for uderstanding the structure of schemaa

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    firebase_uid VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100),
    email VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE chat_sessions (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id) ON DELETE CASCADE,
    topic VARCHAR(100), -- user-selected topic like "Diabetes"
    title VARCHAR(255), -- autogenerated or user-saved (e.g., "Chat on Asthma")
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TYPE sender_type AS ENUM ('user', 'assistant');

CREATE TABLE chat_messages (
    id SERIAL PRIMARY KEY,
    session_id INT REFERENCES chat_sessions(id) ON DELETE CASCADE,
    sender sender_type NOT NULL,
    message TEXT NOT NULL,
    source ENUM('csv', 'rag', 'llm') DEFAULT NULL, -- only for assistant messages
    matched_qa_id INT,  -- for CSV matches
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TYPE answer_source AS ENUM ('csv', 'rag', 'llm');

CREATE TABLE chat_logs (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id) ON DELETE CASCADE,
    chat_session_id INT REFERENCES chat_sessions(id) ON DELETE CASCADE,
    user_query TEXT NOT NULL,
    source answer_source NOT NULL,  -- csv, rag, or llm
    matched_qa_id INT,              -- if CSV match found
    rag_score FLOAT,                -- cosine sim score if RAG used
    llm_answer_used BOOLEAN DEFAULT FALSE,
    llm_answer_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
